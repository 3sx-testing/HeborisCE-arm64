name: build-aarch64-wavonly

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools + cross toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build pkg-config git \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            file zip

      - name: Build SDL2 + SDL2_mixer (WAV-only) for aarch64
        run: |
          set -euxo pipefail
          PREFIX="${GITHUB_WORKSPACE}/aarch64-prefix"
          mkdir -p third_party
          cd third_party

          # SDL2
          git clone --depth 1 https://github.com/libsdl-org/SDL.git SDL
          cmake -S SDL -B SDL/build-a64 -G Ninja \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_INSTALL_PREFIX="$PREFIX" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DSDL_SHARED=ON -DSDL_STATIC=OFF
          cmake --build SDL/build-a64
          cmake --install SDL/build-a64

          # SDL2_mixer (WAV-only)
          git clone --depth 1 https://github.com/libsdl-org/SDL_mixer.git SDL_mixer
          cmake -S SDL_mixer -B SDL_mixer/build-a64 -G Ninja \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_INSTALL_PREFIX="$PREFIX" \
            -DCMAKE_PREFIX_PATH="$PREFIX" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DSDL2MIXER_WAV=ON \
            -DSDL2MIXER_MOD=OFF \
            -DSDL2MIXER_MID=OFF \
            -DSDL2MIXER_MP3=OFF \
            -DSDL2MIXER_FLAC=OFF \
            -DSDL2MIXER_OGG=OFF \
            -DSDL2MIXER_OPUS=OFF \
            -DSDL2MIXER_VENDORED=OFF
          cmake --build SDL_mixer/build-a64
          cmake --install SDL_mixer/build-a64

      - name: Configure Heboris (aarch64)
        run: |
          set -euxo pipefail
          PREFIX="${GITHUB_WORKSPACE}/aarch64-prefix"
          cmake -S . -B build-a64 -G Ninja \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_PREFIX_PATH="$PREFIX" \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build Heboris (aarch64)
        run: |
          set -euxo pipefail
          cmake --build build-a64
          file build-a64/* || true

      - name: Package
        run: |
          set -euxo pipefail
          mkdir -p dist/heboris-sdl/libs

          # Find built binary (adjust pattern if needed)
          BIN="$(find build-a64 -maxdepth 2 -type f -executable | head -n 1)"
          if [ -z "$BIN" ]; then
            echo "No executable found in build-a64"
            find build-a64 -maxdepth 3 -type f
            exit 1
          fi
          cp -v "$BIN" dist/heboris-sdl/

          # Copy resources if present in repo
          if [ -d "res" ]; then
            cp -av res dist/heboris-sdl/
          fi

          # Bundle only the libs we built (SDL2 + SDL2_mixer)
          cp -av aarch64-prefix/lib/libSDL2-2.0.so* dist/heboris-sdl/libs/ || true
          cp -av aarch64-prefix/lib/libSDL2_mixer-2.0.so* dist/heboris-sdl/libs/ || true

          # Run script for RockNIX / PortMaster
          cat > dist/heboris-sdl/run.sh << 'EOF'
          #!/bin/sh
          set -eu
          DIR="$(cd "$(dirname "$0")" && pwd)"
          cd "$DIR"
          export LD_LIBRARY_PATH="$DIR/libs:${LD_LIBRARY_PATH:-}"
          export SDL_AUDIODRIVER=alsa
          exec "./$(ls -1 | head -n 1)"
          EOF
          chmod +x dist/heboris-sdl/run.sh

          (cd dist && zip -r heboris-sdl-aarch64-wavonly.zip heboris-sdl)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: heboris-sdl-aarch64-wavonly
          path: dist/heboris-sdl-aarch64-wavonly.zip
