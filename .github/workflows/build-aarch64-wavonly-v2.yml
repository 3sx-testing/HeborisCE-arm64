name: Heboris WAV-only aarch64

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - ".github/workflows/build-aarch64-wavonly.yml"
      - "**/*.c"
      - "**/*.cpp"
      - "**/*.h"
      - "CMakeLists.txt"
      - "cmake/**"
      - "src/**"

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cross toolchain + aarch64 Wayland/ALSA deps
        run: |
          set -euxo pipefail
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build pkg-config git file zip \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libasound2-dev:arm64 \
            libwayland-dev:arm64 wayland-protocols \
            libxkbcommon-dev:arm64 \
            libdrm-dev:arm64 libgbm-dev:arm64 \
            libegl1-mesa-dev:arm64 libgles2-mesa-dev:arm64

      - name: Build SDL2 + SDL2_mixer (WAV-only) for aarch64
        run: |
          set -euxo pipefail
          PREFIX="${GITHUB_WORKSPACE}/aarch64-prefix"
          mkdir -p third_party
          cd third_party

          # Make pkg-config prefer aarch64 .pc files
          export PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
          export PKG_CONFIG_PATH="$PKG_CONFIG_LIBDIR"

          # ---- SDL2 (NOT SDL3) ----
          if [ ! -d SDL ]; then
            git clone --depth 1 --branch release-2.30.x https://github.com/libsdl-org/SDL.git SDL
          fi

          cmake -S SDL -B SDL/build-a64 -G Ninja \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_INSTALL_PREFIX="$PREFIX" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DSDL_SHARED=ON -DSDL_STATIC=OFF \
            -DSDL_WAYLAND=ON \
            -DSDL_X11=OFF
          cmake --build SDL/build-a64
          cmake --install SDL/build-a64

          # ---- SDL2_mixer (WAV-only) ----
          if [ ! -d SDL_mixer ]; then
            git clone --depth 1 --branch release-2.8.x https://github.com/libsdl-org/SDL_mixer.git SDL_mixer
          fi

          cmake -S SDL_mixer -B SDL_mixer/build-a64 -G Ninja \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_INSTALL_PREFIX="$PREFIX" \
            -DCMAKE_PREFIX_PATH="$PREFIX" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DSDL2MIXER_WAV=ON \
            -DSDL2MIXER_MOD=OFF \
            -DSDL2MIXER_MID=OFF \
            -DSDL2MIXER_MP3=OFF \
            -DSDL2MIXER_FLAC=OFF \
            -DSDL2MIXER_OGG=OFF \
            -DSDL2MIXER_OPUS=OFF \
            -DSDL2MIXER_VENDORED=OFF
          cmake --build SDL_mixer/build-a64
          cmake --install SDL_mixer/build-a64

      - name: Configure Heboris (aarch64)
        run: |
          set -euxo pipefail
          PREFIX="${GITHUB_WORKSPACE}/aarch64-prefix"

          # Prefer aarch64 pkg-config AND our prefix .pc files
          export PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
          export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig:$PREFIX/share/pkgconfig:$PKG_CONFIG_LIBDIR"

          cmake -S . -B build-a64 -G Ninja \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_PREFIX_PATH="$PREFIX" \
            -DCMAKE_FIND_ROOT_PATH="$PREFIX" \
            -DCMAKE_FIND_ROOT_PATH_MODE_PACKAGE=ONLY \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build Heboris (aarch64)
        run: |
          set -euxo pipefail
          cmake --build build-a64
          echo "=== executables ==="
          find build-a64 -maxdepth 3 -type f -executable -print || true

      - name: Package
        run: |
          set -euxo pipefail
          PREFIX="${GITHUB_WORKSPACE}/aarch64-prefix"

          mkdir -p dist/heboris-sdl/libs

          # Find the Heboris binary (match common names)
          BIN="$(find build-a64 -maxdepth 3 -type f -executable \( -name 'Heboris*' -o -name 'heboris*' \) | head -n 1)"
          if [ -z "${BIN:-}" ]; then
            echo "ERROR: Could not find Heboris executable in build-a64."
            find build-a64 -maxdepth 3 -type f -print
            exit 1
          fi
          echo "Using BIN=$BIN"
          cp -v "$BIN" dist/heboris-sdl/

          # Copy resources if present in repo
          if [ -d "res" ]; then
            cp -av res dist/heboris-sdl/
          else
            echo "WARNING: no res/ directory found at repo root (skipping)."
          fi

          # Bundle only SDL2 + SDL2_mixer we built
          cp -av "$PREFIX/lib/libSDL2-2.0.so"* dist/heboris-sdl/libs/ || true
          cp -av "$PREFIX/lib/libSDL2_mixer-2.0.so"* dist/heboris-sdl/libs/ || true

          # RockNIX-friendly run script
          cat > dist/heboris-sdl/run.sh << 'EOF'
          #!/bin/sh
          set -eu
          DIR="$(cd "$(dirname "$0")" && pwd)"
          cd "$DIR"
          export LD_LIBRARY_PATH="$DIR/libs:${LD_LIBRARY_PATH:-}"
          export SDL_AUDIODRIVER=alsa
          exec "./$(ls -1 | grep -E '^(Heboris|heboris)' | head -n 1)"
          EOF
          chmod +x dist/heboris-sdl/run.sh

          echo "=== dist tree ==="
          find dist -maxdepth 4 -type f -print

          (cd dist && zip -r heboris-sdl-aarch64-wavonly.zip heboris-sdl)
          test -f dist/heboris-sdl-aarch64-wavonly.zip
          ls -lh dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: heboris-sdl-aarch64-wavonly
          path: dist/heboris-sdl-aarch64-wavonly.zip
          if-no-files-found: error
