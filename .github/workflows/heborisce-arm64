name: Build HeborisCE (RockNIX-style Linux ARM64)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    name: Build HeborisCE (aarch64)
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.04

    steps:
      - name: Install tools + cross toolchain (RockNIX-style)
        run: |
          set -euxo pipefail
          apt-get update
          apt-get install -y git curl ca-certificates xz-utils

          dpkg --add-architecture arm64

          # Pin DEB822 sources to amd64 only (avoid broken arm64 indexes on security.ubuntu.com)
          for f in /etc/apt/sources.list.d/*.sources; do
            if [ -f "$f" ] && ! grep -q '^Architectures:' "$f"; then
              sed -i '/^Types:/a Architectures: amd64' "$f"
            fi
          done

          # Add arm64 sources via ports.ubuntu.com (this is the trick that made your 3SX workflow work)
          printf '%s\n'             'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky main restricted universe multiverse'             'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky-updates main restricted universe multiverse'             'deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports plucky-security main restricted universe multiverse'             > /etc/apt/sources.list.d/arm64-ports.list

          apt-get update
          apt-get install -y             crossbuild-essential-arm64             cmake ninja-build pkg-config             zip tar file

          # SDL3 + SDL3_image headers/libs (ARM64)
          apt-get install -y             libsdl3-dev:arm64             libsdl3-image-dev:arm64

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Create toolchain file (aarch64-linux-gnu)
        run: |
          set -euxo pipefail
          mkdir -p cmake
          cat > cmake/aarch64-linux-gnu.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)

          set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
          set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
          set(CMAKE_AR aarch64-linux-gnu-ar)
          set(CMAKE_RANLIB aarch64-linux-gnu-ranlib)
          set(CMAKE_STRIP aarch64-linux-gnu-strip)

          # Multiarch locations for :arm64 packages on Ubuntu
          set(CMAKE_LIBRARY_ARCHITECTURE aarch64-linux-gnu)
          set(CMAKE_FIND_ROOT_PATH
              /usr
              /usr/include/aarch64-linux-gnu
              /usr/lib/aarch64-linux-gnu
          )

          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
          EOF

      - name: Configure (Portable package type)
        run: |
          set -euxo pipefail

          # Make pkg-config resolve ARM64 .pc files
          export PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
          export PKG_CONFIG_PATH=$PKG_CONFIG_LIBDIR
          export PKG_CONFIG_SYSROOT_DIR=/

          cmake -S . -B build-linux-arm64 -G Ninja             -DCMAKE_TOOLCHAIN_FILE=cmake/aarch64-linux-gnu.cmake             -DCMAKE_BUILD_TYPE=Release             -DAPP_PACKAGE_TYPE=Portable

      - name: Build
        run: |
          set -euxo pipefail
          cmake --build build-linux-arm64 --parallel
          echo "=== built files ==="
          find build-linux-arm64 -maxdepth 3 -type f -print

      - name: Package (PortMaster-friendly folder)
        run: |
          set -euxo pipefail
          mkdir -p dist/heborisce/libs

          # Find the built binary (common locations across generators)
          BIN="$(find build-linux-arm64 -maxdepth 4 -type f -executable -name 'HeborisCE*' | head -n 1)"
          if [ -z "${BIN:-}" ]; then
            echo "ERROR: Could not find HeborisCE executable in build-linux-arm64"
            find build-linux-arm64 -maxdepth 4 -type f -print
            exit 1
          fi
          echo "Using BIN=$BIN"
          cp -v "$BIN" dist/heborisce/HeborisCE

          # Copy resources (most important is res/)
          if [ -d "res" ]; then
            cp -av res dist/heborisce/
          fi

          # Copy common docs (optional, harmless)
          for f in changelog.txt heboris.txt README* LICENSE*; do
            [ -e "$f" ] && cp -av "$f" dist/heborisce/ || true
          done

          # Bundle SDL3 libs so RockNIX doesn't need to provide them
          cp -av /usr/lib/aarch64-linux-gnu/libSDL3.so* dist/heborisce/libs/ || true
          cp -av /usr/lib/aarch64-linux-gnu/libSDL3_image.so* dist/heborisce/libs/ || true

          # Simple run script
          cat > dist/heborisce/run.sh << 'EOF'
          #!/bin/sh
          set -eu
          DIR="$(cd "$(dirname "$0")" && pwd)"
          cd "$DIR"
          export LD_LIBRARY_PATH="$DIR/libs:${LD_LIBRARY_PATH:-}"
          exec "$DIR/HeborisCE"
          EOF
          chmod +x dist/heborisce/run.sh

          echo "=== package contents ==="
          find dist -maxdepth 4 -type f -print

          (cd dist && tar -czf ../heborisce-linux-arm64.tar.gz heborisce)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: heborisce-linux-arm64
          path: heborisce-linux-arm64.tar.gz
          if-no-files-found: error
